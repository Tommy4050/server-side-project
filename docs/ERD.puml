@startuml
hide methods
skinparam linetype ortho
left to right direction
title GameBay â€“ ER diagram (based on DB dump)

' ========= CORE ENTITIES =========
entity "users" as users {
  *user_id : BIGINT <<PK>>
  --
  username : VARCHAR(50)
  email : VARCHAR(255)
  password_hash : VARCHAR(255)
  status : ENUM
  is_admin : TINYINT(1)
  banned_until : DATETIME
  ban_reason : VARCHAR(255)
  banned_by : BIGINT
  created_at : DATETIME
  --
  billing_full_name : VARCHAR(100)
  billing_address1 : VARCHAR(150)
  billing_address2 : VARCHAR(150)
  billing_city : VARCHAR(100)
  billing_postal_code : VARCHAR(20)
  billing_country : CHAR(2)
}

entity "roles" as roles {
  *role_id : TINYINT <<PK>>
  --
  name : ENUM('admin','user') <<UNQ>>
}

entity "user_roles" as user_roles {
  *user_id : BIGINT <<PK,FK>>
  *role_id : TINYINT <<PK,FK>>
  --
  assigned_at : DATETIME
}

entity "games" as games {
  *game_id : BIGINT <<PK>>
  --
  title : VARCHAR(150)
  description : TEXT
  publisher : VARCHAR(120)
  price : DECIMAL(10,2)
  release_date : DATE
  is_published : TINYINT(1)
  -- sales
  sale_percent : TINYINT
  sale_start : DATE
  sale_end : DATE
  -- media & meta
  image_url : VARCHAR(255)
  created_at : DATETIME
  updated_at : DATETIME
}

entity "genres" as genres {
  *genre_id : BIGINT <<PK>>
  --
  name : VARCHAR(50) <<UNQ>>
}

entity "game_genres" as game_genres {
  *game_id : BIGINT <<PK,FK>>
  *genre_id : BIGINT <<PK,FK>>
}

' ========= STORE / CART / ORDERS =========
entity "shopping_carts" as carts {
  *cart_id : BIGINT <<PK>>
  --
  user_id : BIGINT <<FK>>
  status : ENUM('active','abandoned','converted')
  created_at : DATETIME
  updated_at : DATETIME
}

entity "cart_items" as cart_items {
  *cart_item_id : BIGINT <<PK>>
  --
  cart_id : BIGINT <<FK>>
  game_id : BIGINT <<FK>>
  quantity : INT
  unit_price_at_add : DECIMAL(10,2)
  added_at : DATETIME
}

entity "orders" as orders {
  *order_id : BIGINT <<PK>>
  --
  user_id : BIGINT <<FK>>
  status : ENUM('pending','paid','failed','refunded','cancelled')
  total_amount : DECIMAL(10,2)
  placed_at : DATETIME
  payment_method : ENUM('card','paypal','other')
  -- billing snapshot
  bill_full_name : VARCHAR(100)
  bill_address1 : VARCHAR(150)
  bill_address2 : VARCHAR(150)
  bill_city : VARCHAR(100)
  bill_postal_code : VARCHAR(20)
  bill_country : CHAR(2)
}

entity "order_items" as order_items {
  *order_item_id : BIGINT <<PK>>
  --
  order_id : BIGINT <<FK>>
  game_id : BIGINT <<FK>>
  quantity : INT
  unit_price : DECIMAL(10,2)
}

entity "libraries" as libraries {
  *user_id : BIGINT <<PK,FK>>
  *game_id : BIGINT <<PK,FK>>
  --
  acquired_at : DATETIME
  source : ENUM('purchase','gift','admin_grant')
  total_play_seconds : INT
}

' ========= COMMUNITY =========
entity "posts" as posts {
  *post_id : BIGINT <<PK>>
  --
  user_id : BIGINT <<FK>>
  game_id : BIGINT <<FK>>
  caption : VARCHAR(500)
  image_path : VARCHAR(255)
  visibility : ENUM('public','friends','private')
  is_hidden : TINYINT(1)
  hidden_reason : VARCHAR(255)
  moderated_by : BIGINT <<FK,nullable>>
  is_removed : TINYINT(1)
  created_at : DATETIME
  updated_at : DATETIME
}

entity "post_comments" as post_comments {
  *comment_id : BIGINT <<PK>>
  --
  post_id : BIGINT <<FK>>
  parent_comment_id : BIGINT <<FK,nullable>>
  user_id : BIGINT <<FK>>
  body : VARCHAR(1000)
  is_hidden : TINYINT(1)
  created_at : DATETIME
}

entity "post_likes" as post_likes {
  *post_id : BIGINT <<PK,FK>>
  *user_id : BIGINT <<PK,FK>>
  --
  created_at : DATETIME
}

' (Legacy generic comments/likes exist in DB; app uses post_* tables.)
entity "comments" as comments {
  *comment_id : BIGINT <<PK>>
  --
  post_id : BIGINT <<FK>>
  user_id : BIGINT <<FK>>
  body : VARCHAR(1000)
  is_removed : TINYINT(1)
  created_at : DATETIME
}

' ========= FRIENDS =========
entity "friend_requests" as friend_requests {
  *request_id : BIGINT <<PK>>
  --
  requester_id : BIGINT <<FK>>
  addressee_id : BIGINT <<FK>>
  status : ENUM('pending','accepted','declined','canceled')
  created_at : DATETIME
  decided_at : DATETIME?
}

entity "friendships" as friendships {
  *user_id_a : BIGINT <<PK,FK>>
  *user_id_b : BIGINT <<PK,FK>>
  --
  since : DATETIME
}

' ========= PLAYTIME / PASSWORD RESET =========
entity "play_sessions" as play_sessions {
  *session_id : INT <<PK>>
  --
  user_id : BIGINT <<FK>>
  game_id : BIGINT <<FK>>
  started_at : DATETIME
  ended_at : DATETIME?
  duration_seconds : INT?
}

entity "password_resets" as password_resets {
  *id : BIGINT <<PK>>
  --
  user_id : BIGINT <<FK>>
  token_hash : CHAR(64) <<UNQ>>
  expires_at : DATETIME
  used_at : DATETIME?
  created_at : DATETIME
}

' ========= MODERATION / ADMIN AUDIT =========
entity "moderation_actions" as moderation_actions {
  *action_id : BIGINT <<PK>>
  --
  admin_user_id : BIGINT <<FK>>
  target_post_id : BIGINT?
  target_comment_id : BIGINT?  ' -> comments.comment_id
  target_user_id : BIGINT?
  action_type : ENUM('remove_post','remove_comment','suspend_user','unsuspend_user')
  reason : VARCHAR(500)?
  created_at : DATETIME
}

entity "game_admin_actions" as game_admin_actions {
  *action_id : BIGINT <<PK>>
  --
  admin_user_id : BIGINT <<FK>>
  game_id : BIGINT <<FK>>
  action_type : ENUM('create','update','delete','publish','unpublish')
  notes : VARCHAR(500)?
  created_at : DATETIME
}

' ========= RELATIONSHIPS =========

' roles
users ||--o{ user_roles : assigns
roles ||--o{ user_roles : maps

' catalog
games ||--o{ game_genres : has
genres ||--o{ game_genres : in

' cart & order
users ||--o{ carts : owns
carts ||--o{ cart_items : contains
games ||--o{ cart_items : item

users ||--o{ orders : places
orders ||--o{ order_items : has
games ||--o{ order_items : purchased

' library & playtime
users ||--o{ libraries : owns
games ||--o{ libraries : appears_in
users ||--o{ play_sessions : plays
games ||--o{ play_sessions : session_for

' community
users ||--o{ posts : authors
games ||--o{ posts : related_to
posts ||--o{ post_comments : has
post_comments |o--o{ post_comments : replies_to
users ||--o{ post_comments : writes
posts ||--o{ post_likes : liked
users ||--o{ post_likes : likes

' moderation
users ||--o{ moderation_actions : "admin_user_id"
posts |o--o{ moderation_actions : "target_post_id"
comments |o--o{ moderation_actions : "target_comment_id"
users |o--o{ moderation_actions : "target_user_id"

' admin audit on games
users ||--o{ game_admin_actions : "admin_user_id"
games ||--o{ game_admin_actions : acted_on

' friends
users ||--o{ friend_requests : requester
users ||--o{ friend_requests : addressee
users ||--o{ friendships : user_a
users ||--o{ friendships : user_b

' password reset
users ||--o{ password_resets : resets

' legacy comments table (present in DB, not used by app feeds)
users ||--o{ comments : writes
posts ||--o{ comments : has

note as N1
Crow's foot:
  ||  = exactly one
  |o  = zero or one
  }|  = one or many
  }o  = zero or many
end note

@enduml
